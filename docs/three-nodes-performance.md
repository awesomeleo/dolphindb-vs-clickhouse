
# DolphinDB 与 ClickHouse 集群性能对比

## 概述

### DolphinDB

DolphinDB 是以 C++ 编写的一款分析型的高性能分布式时序数据库，使用高吞吐低延迟的列式内存引擎，集成了功能强大的编程语言和高容量高速度的流数据分析系统，可在数据库中进行复杂的编程和运算，显著减少数据迁移所耗费的时间。
DolphinDB 通过内存引擎、数据本地化、细粒度数据分区和并行计算实现高速的分布式计算，内置流水线、 Map Reduce 和迭代计算等多种计算框架，使用内嵌的分布式文件系统自动管理分区数据及其副本，为分布式计算提供负载均衡和容错能力。
DolphinDB 支持类标准 SQL 的语法，提供类似于 Python 的脚本语言对数据进行操作，也提供其它常用编程语言的 API，在金融领域中的历史数据分析建模与实时流数据处理，以及物联网领域中的海量传感器数据处理与实时分析等场景中表现出色。

### ClickHouse

ClickHouse 也是以 C++ 编写的一款用于联机分析(OLAP)的列式数据库管理系统(DBMS)，是一款真正的列式数据库管理系统。
许多的列式数据库只能在内存中工作，ClickHouse被设计用于工作在传统磁盘上的系统，它提供每GB更低的存储成本，但如果有可以使用SSD和内存，它也会合理的利用这些资源。大型查询可以以很自然的方式在ClickHouse中进行并行化处理，以此来使用当前服务器上可用的所有资源。
ClickHouse支持在表中定义主键。为了使查询能够快速在主键中进行范围查找，数据总是以增量的方式有序的存储在MergeTree中。因此，数据可以持续不断高效的写入到表中，并且写入的过程中不会存在任何加锁的行为。
ClickHouse提供各种各样在允许牺牲数据精度的情况下对查询进行加速的方法：
- 用于近似计算的各类聚合函数，如：distinct values, medians, quantiles
- 基于数据的部分样本进行近似查询。这时，仅会从磁盘检索少部分比例的数据。
- 不使用全部的聚合条件，通过随机选择有限个数据聚合条件进行聚合。这在数据聚合条件满足某些分布条件下，在提供相当准确的聚合结果的同时降低了计算资源的使用。

## 测试环境

在本次测试中，分别为2款数据库软件搭建一个简单集群环境来进行对比。
选用 DolphinDB 0.95.3 和 ClickHouse 19.4.3.11 进行对比。

### 服务器环境

主机：DELL OptiPlex 7060
CPU：Intel Core i7-8700（6 核 12 线程 3.20 GHz）
内存：32 GB （8GB × 4, 2666 MHz）
硬盘：2T HDD （222 MB/s 读取；210 MB/s 写入）
OS：Ubuntu 18.04 LTS

对于DolphinDB，在一台服务器上建立一个控制节点，在另外2台服务器各建立1个代理节点并分别管理1个数据节点。
在本次测试中，主要工作集中在数据节点上。

对于ClickHouse，使用2台建立集群，第3台作为zookeeper的单独服务器。

### 测试集

270 GB 股票交易大数据集（CSV 格式，23 个 CSV，65 亿条）。
我们将纽约证券交易所（NYSE）提供的 2007.08.01 - 2007.08.31 一个月的股市 Level 1 报价数据作为大数据集进行测试，数据集包含 8000 多支股票在一个月内的 交易时间, 股票代码, 买入价, 卖出价, 买入量, 卖出量 等报价信息。
数据集中共有 65 亿（65,6169,3704）条报价记录，一个 CSV 中保存一个交易日的记录，该月共 23 个交易日，未压缩的 CSV 文件共计 270 GB。 来源：https://www.nyse.com/market-data/historical

| Column | DolphinDB 数据类型 | ClickHouse 数据类型 |
| ------ | ------------------ | ------------------- |
| symbol | SYMBOL             | String              |
| date   | DATE               | Date                |
| time   | SECOND             | DateTime            |
| bid    | DOUBLE             | Float64             |
| ofr    | DOUBLE             | Float64             |
| bidsiz | INT                | Int32               |
| ofrsiz | INT                | Int32               |
| mode   | INT                | Int32               |
| ex     | CHAR               | Int8                |
| mmid   | SYMBOL             | String              |


## 性能对比


### 导入性能

DolphinDB: 35min 30.3s
ClickHouse: 47min 53s


### 查询性能

0. 查询总数
1. 点查询：按股票代码、时间查询
2. 范围查询：查询某时间段内的某些股票的所有记录
3. top1000 + 排序: 按 [股票代码、日期] 过滤，按 [卖出与买入价格差] 降序 排序
4. 聚合查询. 单分区维度
5. 聚合查询.多分区维度 + 排序
6. 经典查询：按 [多个股票代码、日期，时间范围、报价范围] 过滤，查询 [股票代码、时间、买入价、卖出价]
7. 经典查询：计算某天 (每个股票 每分钟) 最大卖出与最小买入价之差


| 样例        | DolphinDB 用时(第一次查询) | ClickHouse 用时(第一次查询) | DolphinDB 用时(连续查询) | ClickHouse 用时(连续查询) |
| ----------- | -------------------------- | --------------------------- | ------------------------ | ------------------------- |
| 0. 查询总数 | 105ms  109ms  105ms        | 23s 546ms                   | 103ms  94ms  85ms        | 455ms  461ms  462ms       |
| 1. 点查询   | 117ms  149ms  165ms        | 138ms  141ms  147ms         | 11ms  12ms  7ms          | 145ms  144ms  144ms       |
| 2. 范围查询 | 182ms  211ms  208ms        | 764ms  789ms  767ms         | 67ms  66ms  67ms         | 792ms  802ms  799 ms      |
| 3. top1000  | 173ms  200ms  188ms        | 55ms  80 ms  42ms           | 27ms  22ms  28ms         | 48ms  41ms  41ms          |
| 4. 聚合查询 | 45ms  102ms  74ms          | 19ms  26ms  24ms            | 16ms  32ms  13ms         | 22ms  29ms  27ms          |
| 5. 聚合查询 | 137ms  166m  157ms         | 116ms 118ms  92ms           | 46ms  45ms  45ms         | 87ms  59ms  66ms          |
| 6. 经典查询 | 1477ms  1506ms  1546ms     | 185ms  177ms  183ms         | 1429ms  1463ms  1424ms   | 194ms  191ms 171ms        |
| 7. 经典查询 | 4414ms  4313ms             | 23812ms  29471ms            | 4057ms 4059ms 4146ms     | 7608ms  7514ms  7504ms    |

